<?xml version="1.0"?>
<robot name="marid" xmlns:xacro="http://www.ros.org/wiki/xacro">

    <!-- WIND ENABLE -->
    <gazebo>
      <enable_wind>true</enable_wind>
    </gazebo>
    <gazebo reference="left_wing"><enable_wind>true</enable_wind></gazebo>
    <gazebo reference="right_wing"><enable_wind>true</enable_wind></gazebo>
    <gazebo reference="base_link_front"><enable_wind>true</enable_wind></gazebo>
    <gazebo reference="main_tail"><enable_wind>true</enable_wind></gazebo>
    <gazebo reference="tail_right"><enable_wind>true</enable_wind></gazebo>
    <gazebo reference="tail_left"><enable_wind>true</enable_wind></gazebo>



    <gazebo reference="left_wing">
        <kp>1e6</kp>
        <kd>1.0</kd>
        <minDepth>0.001</minDepth>
        <maxVel>0.1</maxVel>
    </gazebo>

    <gazebo reference="right_wing">
        <kp>1e6</kp>
        <kd>1.0</kd>
        <minDepth>0.001</minDepth>
        <maxVel>0.1</maxVel>
    </gazebo>

    <gazebo reference="tail_left">
        <kp>1e6</kp>
        <kd>1.0</kd>
        <minDepth>0.001</minDepth>
        <maxVel>0.1</maxVel>
    </gazebo>

    <gazebo reference="tail_right">
        <kp>1e6</kp>
        <kd>1.0</kd>
        <minDepth>0.001</minDepth>
        <maxVel>0.1</maxVel>
    </gazebo>


    <gazebo>
        <plugin filename="libgz-sim8-lift-drag-system.so" name="gz::sim::systems::LiftDrag">
            <link_name>left_wing</link_name>
            <air_density>1.225</air_density>  <!-- Air density at sea level (kg/m³) -->
            <area>0.20674668328</area>  <!-- Increased for testing -->
            <a0>0.0</a0>  <!-- Zero-lift angle of attack (radians) -->
            <cla>3.0</cla>    <!-- Lift coefficient for wing -->
            <cda>0.5</cda>     <!-- Increased drag -->
            <alpha_stall>0.35</alpha_stall>
            <forward>0 1 0</forward>
            <up>0 0 1</up>
            <cp>0 0 0</cp>  <!-- Removed offset to prevent unwanted rotation -->
            <debug>true</debug>  <!-- ADD DEBUG OUTPUT -->
            <visualize>true</visualize>  <!-- VISUAL FORCES -->
        </plugin>
    </gazebo>

    <gazebo>
        <plugin filename="libgz-sim8-lift-drag-system.so" name="gz::sim::systems::LiftDrag">
            <link_name>right_wing</link_name>
            <air_density>1.225</air_density>  <!-- Air density at sea level (kg/m³) -->
            <area>0.20674668328</area>
            <a0>0.0</a0>  <!-- Zero-lift angle of attack (radians) -->
            <cla>3.0</cla>    <!-- Lift coefficient for wing -->
            <cda>0.5</cda>
            <alpha_stall>0.35</alpha_stall>
            <forward>0 1 0</forward>
            <up>0 0 1</up>
            <cp>0 0 0</cp>  <!-- Removed offset to prevent unwanted rotation -->
            <debug>true</debug>
            <visualize>true</visualize>
        </plugin>
    </gazebo>

 
    <gazebo>
        <plugin filename="libgz-sim8-lift-drag-system.so" name="gz::sim::systems::LiftDrag">
            <link_name>tail_left</link_name>
            <air_density>1.225</air_density>  <!-- Air density at sea level (kg/m³) -->
            <area>0.05733020792</area>  <!-- Increased for testing -->
            <a0>0.0</a0>  <!-- Zero-lift angle of attack (radians) -->
            <cla>0.8</cla>    <!-- Reasonable value for V-tail control surfaces -->
            <cda>0.5</cda>     <!-- Increased drag -->
            <alpha_stall>0.35</alpha_stall>
            <forward>0 1 0</forward>
            <up>0 0 1</up>
            <cp>0 0 0</cp>  <!-- Removed offset to prevent unwanted rotation -->
            <debug>true</debug>  <!-- ADD DEBUG OUTPUT -->
            <visualize>true</visualize>  <!-- VISUAL FORCES -->
        </plugin>
    </gazebo>

    <gazebo>
        <plugin filename="libgz-sim8-lift-drag-system.so" name="gz::sim::systems::LiftDrag">
            <link_name>tail_right</link_name>
            <air_density>1.225</air_density>  <!-- Air density at sea level (kg/m³) -->
            <area>0.05733020792</area>
            <a0>0.0</a0>  <!-- Zero-lift angle of attack (radians) -->
            <cla>0.8</cla>    <!-- Reasonable value for V-tail control surfaces -->
            <cda>0.5</cda>
            <alpha_stall>0.35</alpha_stall>
            <forward>0 1 0</forward>
            <up>0 0 1</up>
            <cp>0 0 0</cp>  <!-- Removed offset to prevent unwanted rotation -->
            <debug>true</debug>
            <visualize>true</visualize>
        </plugin>
    </gazebo>

    

    <gazebo>
        <plugin filename="libgz-sim8-lift-drag-system.so" name="gz::sim::systems::LiftDrag">
            <link_name>base_link_front</link_name>
            <air_density>1.225</air_density>  <!-- Air density at sea level (kg/m³) -->
            <area>1.1425454568</area>
            <a0>0.0</a0>  <!-- Zero-lift angle of attack (radians) -->
            <cla>0.5</cla>  <!-- Added positive lift coefficient to counteract downward motion -->
            <cda>0.2</cda>  <!-- Increased drag -->
            <alpha_stall>1.57</alpha_stall>
            <forward>0 1 0</forward>
            <up>0 0 1</up>
            <cp>0 0 0</cp>  <!-- No offset for fuselage -->
            <debug>true</debug>
        </plugin>
    </gazebo>

    <!-- Aerodynamic Damping for Main Body (prevents uncontrolled rotations and drift) -->
    <gazebo reference="base_link_front">
        <plugin filename="libgz-sim8-hydrodynamics-system.so" 
                name="gz::sim::systems::Hydrodynamics">
            <link_name>base_link_front</link_name>
            
            <!-- Linear drag coefficients (X, Y, Z) - acts like air resistance -->
            <xDotU>-0.5</xDotU>    <!-- Forward drag (X-axis) -->
            <yDotV>-1.0</yDotV>    <!-- Side drag (Y-axis - your forward) -->
            <zDotW>-1.0</zDotW>    <!-- Vertical drag (Z-axis) -->
            
            <!-- Angular drag coefficients (Roll, Pitch, Yaw) - rotational damping -->
            <kDotP>-2.0</kDotP>    <!-- Roll damping (around X) -->
            <mDotQ>-2.0</mDotQ>     <!-- Pitch damping (around Y) -->
            <nDotR>-2.0</nDotR>     <!-- Yaw damping (around Z) -->
            
            <!-- Quadratic drag (velocity-squared terms) -->
            <xUabsU>-0.1</xUabsU>   <!-- Forward quadratic drag -->
            <yVabsV>-0.2</yVabsV>   <!-- Side quadratic drag -->
            <zWabsW>-0.2</zWabsW>   <!-- Vertical quadratic drag -->
            <kPabsP>-1.0</kPabsP>  <!-- Roll quadratic damping -->
            <mQabsQ>-1.0</mQabsQ>  <!-- Pitch quadratic damping -->
            <nRabsR>-1.0</nRabsR>  <!-- Yaw quadratic damping -->
            
            <!-- Linear velocity terms (usually zero for air) -->
            <xU>0</xU>
            <yV>0</yV>
            <zW>0</zW>
            <kP>0</kP>
            <mQ>0</mQ>
            <nR>0</nR>
        </plugin>
    </gazebo>

    <gazebo reference="main_tail">
        <plugin filename="libgz-sim8-lift-drag-system.so" name="gz::sim::systems::LiftDrag">
            <link_name>main_tail</link_name>
            <air_density>1.225</air_density>  <!-- Air density at sea level (kg/m³) -->
            <area>0.1447926136</area>
            <a0>0.0</a0>  <!-- Zero-lift angle of attack (radians) -->
            <cla>0.4</cla>  <!-- Reverted to original value -->
            <cda>0.15</cda>  <!-- Increased drag -->
            <alpha_stall>1.57</alpha_stall>
            <forward>0 1 0</forward>
            <up>0 0 1</up>
            <cp>0 0 0</cp>  <!-- No offset for tail -->
            <debug>true</debug>
        </plugin>
    </gazebo>

    <!-- ===== THRUSTER PLUGINS ===== -->
    <!-- Left Thruster -->
    <!-- Gazebo Sim 8 Thruster plugin uses default topic: /model/{namespace}/joint/{joint_name}/cmd_vel -->
    <gazebo>
        <plugin filename="libgz-sim8-thruster-system.so" name="gz::sim::systems::Thruster">
            <namespace>marid</namespace>
            <joint_name>thruster_L_joint</joint_name>
            <fluid_density>1.225</fluid_density>  <!-- Air density at sea level (kg/m³) -->
            <propeller_diameter>0.2</propeller_diameter>  <!-- Adjust based on your propeller size (meters) -->
            <thrust_coefficient>0.8</thrust_coefficient>  <!-- Typical range: 0.6-1.0 -->
            <use_angvel_cmd>true</use_angvel_cmd>  <!-- Accept angular velocity commands (rad/s) -->
        </plugin>
    </gazebo>

    <!-- Right Thruster -->
    <gazebo>
        <plugin filename="libgz-sim8-thruster-system.so" name="gz::sim::systems::Thruster">
            <namespace>marid</namespace>
            <joint_name>thruster_R_joint</joint_name>
            <fluid_density>1.225</fluid_density>
            <propeller_diameter>0.2</propeller_diameter>
            <thrust_coefficient>0.8</thrust_coefficient>  <!-- Typical range: 0.6-1.0 -->
            <use_angvel_cmd>true</use_angvel_cmd>
        </plugin>
    </gazebo>

    <!-- Center Thruster (for single-thruster testing) -->
    <gazebo>
        <plugin filename="libgz-sim8-thruster-system.so" name="gz::sim::systems::Thruster">
            <namespace>marid</namespace>
            <joint_name>thruster_center_joint</joint_name>
            <fluid_density>1.225</fluid_density>
            <propeller_diameter>0.2</propeller_diameter>
            <thrust_coefficient>0.8</thrust_coefficient>
            <use_angvel_cmd>true</use_angvel_cmd>
        </plugin>
    </gazebo>

    <!-- ===== JOINT POSITION CONTROLLERS FOR CONTROL SURFACES ===== -->
    <!-- Left Wing Position Controller -->
    <gazebo>
        <plugin filename="libgz-sim8-joint-position-controller-system.so" 
                name="gz::sim::systems::JointPositionController">
            <joint_name>left_wing_joint</joint_name>
            <p_gain>15.0</p_gain>  <!-- Increased to overcome damping (2.5) + friction (1.0) for servo-like behavior -->
            <topic>/model/marid/joint/left_wing_joint/cmd_pos</topic>
        </plugin>
    </gazebo>

    <!-- Right Wing Position Controller -->
    <gazebo>
        <plugin filename="libgz-sim8-joint-position-controller-system.so" 
                name="gz::sim::systems::JointPositionController">
            <joint_name>right_wing_joint</joint_name>
            <p_gain>15.0</p_gain>  <!-- Increased to overcome damping (2.5) + friction (1.0) for servo-like behavior -->
            <topic>/model/marid/joint/right_wing_joint/cmd_pos</topic>
        </plugin>
    </gazebo>

    <!-- Left Tail Position Controller -->
    <gazebo>
        <plugin filename="libgz-sim8-joint-position-controller-system.so" 
                name="gz::sim::systems::JointPositionController">
            <joint_name>tail_left_joint</joint_name>
            <p_gain>15.0</p_gain>  <!-- Increased to overcome damping (2.5) + friction (1.0) for servo-like behavior -->
            <topic>/model/marid/joint/tail_left_joint/cmd_pos</topic>
        </plugin>
    </gazebo>

    <!-- Right Tail Position Controller -->
    <gazebo>
        <plugin filename="libgz-sim8-joint-position-controller-system.so" 
                name="gz::sim::systems::JointPositionController">
            <joint_name>tail_right_joint</joint_name>
            <p_gain>15.0</p_gain>  <!-- Increased to overcome damping (2.5) + friction (1.0) for servo-like behavior -->
            <topic>/model/marid/joint/tail_right_joint/cmd_pos</topic>
        </plugin>
    </gazebo>


    <gazebo reference="imu_link">
      <sensor name="imu" type="imu">
          <always_on>true</always_on>
          <update_rate>100</update_rate>
          <gz_frame_id>imu_link</gz_frame_id>
          <topic>/imu</topic>
          <imu>
            <enable_orientation>true</enable_orientation>
            <angular_velocity>
              <x>
                <noise type="gaussian">
                  <mean>0.0</mean>
                  <stddev>2e-4</stddev>
                </noise>
              </x>
              <y>
                <noise type="gaussian">
                  <mean>0.0</mean>
                  <stddev>2e-4</stddev>
                </noise>
              </y>
              <z>
                <noise type="gaussian">
                  <mean>0.0</mean>
                  <stddev>2e-4</stddev>
                </noise>
              </z>
            </angular_velocity>
            <linear_acceleration>
              <x>
                <noise type="gaussian">
                  <mean>0.0</mean>
                  <stddev>1.7e-2</stddev>
                </noise>
              </x>
              <y>
                <noise type="gaussian">
                  <mean>0.0</mean>
                  <stddev>1.7e-2</stddev>
                </noise>
              </y>
              <z>
                <noise type="gaussian">
                  <mean>0.0</mean>
                  <stddev>1.7e-2</stddev>
                </noise>
              </z>
            </linear_acceleration>
          </imu>
      </sensor>
    </gazebo>

    <gazebo reference="gps_link">
      <sensor name="gps_sensor" type="navsat">
        <always_on>true</always_on>
        <update_rate>10</update_rate> <!-- 10 Hz typical for consumer GPS -->
        <topic>/gps/fix</topic>
        <gz_frame_id>gps_link</gz_frame_id>
        
        <!-- GPS Noise Model (realistic consumer-grade GPS) -->
        <!-- WARNING: gz-sensors NavSat treats stddev as DEGREES not meters (bug #325). -->
        <!-- Use 0.00002 ≈ 2.2m at 37°N; 2.5 would add ±2.5° ≈ ±280km noise. -->
        <navsat>
          <position_sensing>
            <horizontal>
              <noise type="gaussian">
                <mean>0.0</mean>
                <stddev>0.00002</stddev> <!-- ~2.5m equiv (workaround for degrees bug) -->
              </noise>
            </horizontal>
            <vertical>
              <noise type="gaussian">
                <mean>0.0</mean>
                <stddev>0.00002</stddev> <!-- ~2.5m equiv (workaround for degrees bug) -->
              </noise>
            </vertical>
          </position_sensing>
          
          <!-- Velocity sensing (from Doppler shift) -->
          <velocity_sensing>
            <horizontal>
              <noise type="gaussian">
                <mean>0.0</mean>
                <stddev>1.5</stddev> <!-- 0.1 m/s velocity accuracy -->
              </noise>
            </horizontal>
            <vertical>
              <noise type="gaussian">
                <mean>0.0</mean>
                <stddev>1.5</stddev>
              </noise>
            </vertical>
          </velocity_sensing>
        </navsat>
      </sensor>
    </gazebo>

    <!-- 3D LIDAR Sensor -->
    <gazebo reference="lidar_link">
      <sensor name="lidar" type="gpu_lidar">
        <always_on>true</always_on>
        <update_rate>10</update_rate>  <!-- 10 Hz for 3D LIDAR (more data to process) -->
        <visualize>true</visualize>
        <topic>/lidar/scan</topic>
        <gz_frame_id>lidar_link</gz_frame_id>
        <ray>
          <scan>
            <horizontal>
              <samples>360</samples>  <!-- 360 degrees horizontal scan -->
              <resolution>1.0</resolution>
              <min_angle>-3.14159</min_angle>  <!-- -180 degrees -->
              <max_angle>3.14159</max_angle>   <!-- +180 degrees -->
            </horizontal>
            <vertical>
              <samples>16</samples>  <!-- 16 vertical scan lines for 3D -->
              <resolution>1.0</resolution>
              <min_angle>-0.2618</min_angle>  <!-- -15 degrees down -->
              <max_angle>0.2618</max_angle>   <!-- +15 degrees up -->
            </vertical>
          </scan>
          <range>
            <min>0.1</min>   <!-- 10 cm minimum range -->
            <max>100.0</max> <!-- 100 m maximum range -->
            <resolution>0.01</resolution>  <!-- 1 cm resolution -->
          </range>
          <noise>
            <type>gaussian</type>
            <mean>0.0</mean>
            <stddev>0.01</stddev>  <!-- 1 cm standard deviation -->
          </noise>
        </ray>
        <!-- Gazebo Sim 8 uses the sensors system to publish lidar topics.
             The older gz-sim-lidar-system plugin is not available on gz-sim8,
             and causes: "Failed to load system plugin [gz-sim-lidar-system]".
             Keeping the <topic> inside the <sensor> is sufficient. -->
      </sensor>
    </gazebo>

    <!-- Optional: Magnetometer for heading -->
    <gazebo reference="imu_link">
      <sensor name="magnetometer" type="magnetometer">
        <always_on>true</always_on>
        <update_rate>50</update_rate>
        <topic>/magnetometer</topic>
        <magnetometer>
          <x>
            <noise type="gaussian">
              <mean>0.0</mean>
              <stddev>0.01</stddev>
            </noise>
          </x>
          <y>
            <noise type="gaussian">
              <mean>0.0</mean>
              <stddev>0.01</stddev>
            </noise>
          </y>
          <z>
            <noise type="gaussian">
              <mean>0.0</mean>
              <stddev>0.01</stddev>
            </noise>
          </z>
        </magnetometer>
      </sensor>
    </gazebo>


    <gazebo reference="pitot_link">
      <sensor name="airspeed" type="air_speed">
        <always_on>true</always_on>
        <update_rate>50</update_rate>
        <topic>/airspeed</topic>
        <air_speed>
          <pressure>
            <noise type="gaussian">
              <mean>0.0</mean>
              <stddev>0.1</stddev> <!-- 0.1 m/s accuracy -->
            </noise>
          </pressure>
        </air_speed>
      </sensor>
    </gazebo>



    <gazebo reference="baro_link">
      <sensor name="baro" type="air_pressure">
        <update_rate>50</update_rate>
        <always_on>true</always_on>
        <topic>/baro/pressure</topic>
        <noise type="gaussian">
          <mean>0.0</mean>
          <stddev>5.0</stddev>
        </noise>
      </sensor>
    </gazebo>

    <!-- Pose Publisher Plugin - publishes model pose for localization -->
    <gazebo reference="base_link_front">
      <plugin filename="gz-sim-pose-publisher-system" name="gz::sim::systems::PosePublisher">
        <publish_link_pose>true</publish_link_pose>
        <publish_sensor_pose>false</publish_sensor_pose>
        <publish_nested_model_pose>false</publish_nested_model_pose>
        <use_pose_vector_msg>true</use_pose_vector_msg>
        <update_rate>50</update_rate>
      </plugin>
    </gazebo>

    <!-- Odometry Publisher - ground-truth odom for EKF (pose + twist in odom frame) -->
    <gazebo>
      <plugin filename="gz-sim-odometry-publisher-system" name="gz::sim::systems::OdometryPublisher">
        <odom_topic>/model/marid/odometry</odom_topic>
        <odom_frame>odom</odom_frame>
        <robot_base_frame>base_link_front</robot_base_frame>
        <publish_tf>false</publish_tf>
      </plugin>
    </gazebo>

        <!-- Camera for perception / ML -->
    <gazebo reference="camera_link">
      <sensor name="camera" type="camera">
        <always_on>true</always_on>
        <update_rate>30</update_rate>
        <visualize>true</visualize>
        <topic>/camera/image_raw</topic>
        <camera>
          <horizontal_fov>1.047</horizontal_fov>  <!-- ~60 deg -->
          <image>
            <width>640</width>
            <height>480</height>
            <format>R8G8B8</format>
          </image>
          <clip>
            <near>0.1</near>
            <far>100</far>
          </clip>
        </camera>
      </sensor>
    </gazebo>



    <gazebo>
          <xacro:if value="$(arg is_ignition)">
              <plugin filename="ign_ros2_control-system" name="ign_ros2_control::IgnitionROS2ControlPlugin">
                  <parameters>$(find marid_controller)/config/marid_controllers.yaml</parameters>
              </plugin>


              <plugin filename="gz-sim-imu-system" name="gz::sim::v8::systems::Imu"></plugin>

              <!-- NavSat (GPS) System Plugin -->
              <plugin filename="libgz-sim8-navsat-system" name="gz::sim::v8::systems::NavSat"></plugin>

              <!-- Magnetometer System Plugin -->
              <plugin filename="gz-sim-magnetometer-system" name="gz::sim::v8::systems::Magnetometer"></plugin>

              <!-- Air Pressure (Barometer) System Plugin -->
              <plugin filename="gz-sim-air-pressure-system" name="gz::sim::v8::systems::AirPressure"></plugin>

              <!-- Air Speed (Pitot) System Plugin -->
              <plugin filename="gz-sim-air-speed-system" name="gz::sim::v8::systems::AirSpeed"></plugin>


          </xacro:if>


          <xacro:unless value="$(arg is_ignition)">

              <plugin filename="gz_ros2_control-system" name="gz_ros2_control::GazeboSimROS2ControlPlugin">
                  <parameters>$(find marid_controller)/config/marid_controllers.yaml</parameters>
              </plugin>

              <plugin filename="gz-sim-imu-system" name="gz::sim::v8::systems::Imu"></plugin>

              <!-- NavSat (GPS) System Plugin -->
              <plugin filename="libgz-sim8-navsat-system" name="gz::sim::v8::systems::NavSat"></plugin>

              <!-- Magnetometer System Plugin -->
              <plugin filename="gz-sim-magnetometer-system" name="gz::sim::v8::systems::Magnetometer"></plugin>

              <!-- Air Pressure (Barometer) System Plugin -->
              <plugin filename="gz-sim-air-pressure-system" name="gz::sim::v8::systems::AirPressure"></plugin>

              <!-- Air Speed (Pitot) System Plugin -->
              <plugin filename="gz-sim-air-speed-system" name="gz::sim::v8::systems::AirSpeed"></plugin>

          </xacro:unless>
      </gazebo>


</robot>
